import api from "./apiConfig";

//FUNCIONES DE INSCRIPCI√ìN GRUPAL

// Registrar m√∫ltiples tutores
export const registrarTutoresGrupales = async (procesoId, tutores) => {
  try {
    console.log("üì§ Registrando tutores grupales:", { procesoId, tutores });
    const response = await api.post(`/inscripcion/grupal/proceso/${procesoId}/tutores`, {
      tutores
    });
    console.log("‚úÖ Tutores grupales registrados:", response.data);
    return response;
  } catch (error) {
    console.error("‚ùå Error al registrar tutores grupales:", error);
    throw error;
  }
};

// Registrar m√∫ltiples competidores
export const registrarCompetidoresGrupales = async (procesoId, competidores) => {
  try {
    console.log("üì§ Registrando competidores grupales:", { procesoId, competidores });
    const response = await api.post(`/inscripcion/grupal/proceso/${procesoId}/competidores`, {
      competidores
    });
    console.log("‚úÖ Competidores grupales registrados:", response.data);
    return response;
  } catch (error) {
    console.error("‚ùå Error al registrar competidores grupales:", error);
    
    // Logging mejorado para error 422
    if (error.response) {
      console.error("Status:", error.response.status);
      console.error("Data:", error.response.data);
      console.error("Headers:", error.response.headers);
      
      if (error.response.status === 422) {
        console.error("üîç Errores de validaci√≥n:", error.response.data.errors || error.response.data);
        
        // Crear mensaje de error m√°s detallado
        const validationErrors = error.response.data.errors;
        if (validationErrors) {
          const errorMessages = Object.entries(validationErrors)
            .map(([field, messages]) => `${field}: ${messages.join(', ')}`)
            .join('\n');
          throw new Error(`Errores de validaci√≥n:\n${errorMessages}`);
        }
      }
    }
    
    throw error;
  }
};

// Procesar archivo Excel/CSV para competidores
export const procesarArchivoGrupal = async (procesoId, archivo) => {
  try {
    console.log("üì§ Procesando archivo grupal:", { 
      procesoId, 
      archivoNombre: archivo.name, 
      archivoTama√±o: archivo.size,
      archivoTipo: archivo.type,
      archivoLastModified: archivo.lastModified
    });
    
    // Validaciones del lado del cliente
    if (!archivo.name.toLowerCase().endsWith('.csv')) {
      throw new Error('El archivo debe ser un CSV v√°lido');
    }
    
    if (archivo.size > 5 * 1024 * 1024) { // 5MB
      throw new Error('El archivo es demasiado grande (m√°ximo 5MB)');
    }
    
    const formData = new FormData();
    
    // Crear un nuevo File object con el tipo MIME correcto para CSV
    const archivoConTipoCSV = new File([archivo], archivo.name, {
      type: 'text/csv',
      lastModified: archivo.lastModified
    });
    
    console.log("üì§ Archivo CSV normalizado:", {
      nombre: archivoConTipoCSV.name,
      tipo: archivoConTipoCSV.type,
      tama√±o: archivoConTipoCSV.size
    });
    
    formData.append('file', archivoConTipoCSV); // Cambio de 'archivo' a 'file' para coincidir con el backend
    
    const response = await api.post(`/inscripcion/grupal/proceso/${procesoId}/excel`, formData, {
      headers: {
        'Content-Type': 'multipart/form-data',
      },
      timeout: 30000, // 30 segundos de timeout
    });
    
    console.log("‚úÖ Archivo grupal procesado:", response.data);
    
    if (response.data.success && response.data.competidores) {
      console.log(`‚úÖ ${response.data.competidores.length} competidores procesados correctamente`);
    }
    
    return response;  } catch (error) {
    console.error("‚ùå Error al procesar archivo grupal:", error);
    
    // Mejorar el manejo de errores
    if (error.response) {
      // Error del servidor
      const { status, data } = error.response;
      console.error(`‚ùå Error del servidor (${status}):`, data);
        if (status === 422) {
        // Errores de validaci√≥n espec√≠ficos
        console.error("üîç Detalles del error 422:", {
          data: data,
          message: data.message || 'No message',
          errors: data.errors || 'No errors'
        });
        
        // Loggear los errores espec√≠ficos
        console.error("üîç Errores espec√≠ficos:", JSON.stringify(data.errors, null, 2));
        
        if (data.errors && typeof data.errors === 'object') {
          const erroresDetallados = Object.entries(data.errors)
            .map(([campo, mensajes]) => `${campo}: ${Array.isArray(mensajes) ? mensajes.join(', ') : mensajes}`)
            .join('\n');
          throw new Error(`Errores de validaci√≥n del archivo:\n${erroresDetallados}`);
        } else if (data.message) {
          // Si no hay errores espec√≠ficos, usar el mensaje general
          throw new Error(`Error de validaci√≥n: ${data.message}`);
        } else {
          throw new Error("Error de validaci√≥n del archivo. Verifique que sea un archivo CSV v√°lido con el formato correcto.");
        }
      } else if (data.mensaje) {
        throw new Error(data.mensaje);
      }
    } else if (error.request) {
      // Error de red
      console.error("‚ùå Error de red:", error.request);
      throw new Error("Error de conexi√≥n. Verifique su conexi√≥n a internet.");
    }
    
    throw error;
  }
};

// Asignar √°reas y niveles a competidores grupales
export const asignarAreasNivelesGrupales = async (procesoId, asignaciones) => {
  try {
    console.log("üì§ Asignando √°reas y niveles grupales:", { procesoId, asignaciones });
    const response = await api.post(`/inscripcion/grupal/proceso/${procesoId}/areas-niveles`, {
      asignaciones
    });
    console.log("‚úÖ √Åreas y niveles asignados:", response.data);
    return response;
  } catch (error) {
    console.error("‚ùå Error al asignar √°reas y niveles:", error);
    console.error("‚ùå Detalles del error:", {
      status: error.response?.status,
      statusText: error.response?.statusText,
      data: error.response?.data,
      errors: error.response?.data?.errors
    });
    throw error;
  }
};

// Crear grupo y finalizar inscripci√≥n
export const crearGrupoInscripcion = async (procesoId, datosGrupo) => {
  try {
    console.log("üì§ Creando grupo de inscripci√≥n:", { procesoId, datosGrupo });
    const response = await api.post(`/inscripcion/grupal/proceso/${procesoId}/grupo`, datosGrupo);
    console.log("‚úÖ Grupo de inscripci√≥n creado:", response.data);
    return response;
  } catch (error) {
    console.error("‚ùå Error al crear grupo de inscripci√≥n:", error);
    throw error;
  }
};

// Obtener resumen de inscripci√≥n grupal
export const obtenerResumenInscripcionGrupal = async (procesoId) => {
  try {
    console.log("üì§ Obteniendo resumen de inscripci√≥n grupal:", { procesoId });
    const response = await api.get(`/inscripcion/grupal/proceso/${procesoId}/resumen`);
    console.log("‚úÖ Resumen obtenido:", response.data);
    return response;
  } catch (error) {
    console.error("‚ùå Error al obtener resumen grupal:", error);
    throw error;
  }
};

// Generar boleta grupal
export const generarBoletaGrupal = async (procesoId) => {
  try {
    console.log("üì§ Generando boleta grupal:", { procesoId });
    const response = await api.post(`/inscripcion/grupal/proceso/${procesoId}/boleta`);
    console.log("‚úÖ Boleta grupal generada:", response.data);
    return response;
  } catch (error) {
    console.error("‚ùå Error al generar boleta grupal:", error);
    throw error;
  }
};

// Calcular costos preliminares para inscripci√≥n grupal
// Esta funci√≥n usa el endpoint espec√≠fico para inscripciones grupales que calcula correctamente por √°rea
export const calcularCostosGrupales = async (procesoId, areasIds, nivelesIds) => {
  try {
    console.log("üì§ Calculando costos grupales espec√≠ficos:", { procesoId, areasIds, nivelesIds });
    const response = await api.post(`/inscripcion/grupal/proceso/${procesoId}/calcular-costos`, {
      areas_ids: areasIds,
      niveles_ids: nivelesIds
    });
    console.log("‚úÖ Costos grupales calculados:", response.data);
    return response;
  } catch (error) {
    console.error("‚ùå Error al calcular costos grupales:", error);
    throw error;
  }
};

// Funciones para manejo de archivos Excel (para inscripci√≥n grupal)
export const cargarArchivoExcel = async (procesoId, archivo) => {
  try {
    console.log("üì§ Cargando archivo Excel:", { procesoId });
    return await procesarArchivoGrupal(procesoId, archivo);
  } catch (error) {
    console.error("‚ùå Error al cargar archivo Excel:", error);
    throw error;
  }
};

export const descargarPlantillaExcel = async () => {
  try {
    console.log("üì§ Descargando plantilla CSV");
    const response = await api.get('/inscripcion/grupal/plantilla-excel', {
      responseType: 'blob',
      timeout: 30000, // 30 segundos de timeout
    });
    
    console.log("‚úÖ Respuesta de plantilla recibida:", {
      size: response.data.size,
      type: response.data.type
    });
    
    // Crear un enlace de descarga
    const url = window.URL.createObjectURL(new Blob([response.data], { type: 'text/csv; charset=utf-8' }));
    const link = document.createElement('a');
    link.href = url;
    
    // Obtener fecha actual para nombre √∫nico
    const fecha = new Date().toISOString().slice(0, 10);
    link.setAttribute('download', `plantilla_inscripcion_grupal_${fecha}.csv`);
    
    document.body.appendChild(link);
    link.click();
    link.remove();
    window.URL.revokeObjectURL(url);
    
    console.log("‚úÖ Plantilla CSV descargada exitosamente");
    return { success: true, mensaje: "Plantilla descargada correctamente" };
  } catch (error) {
    console.error("‚ùå Error al descargar plantilla:", error);
    
    if (error.response) {
      const { status, data } = error.response;
      console.error(`‚ùå Error del servidor (${status}):`, data);
      
      if (status === 401) {
        throw new Error("No tiene permisos para descargar la plantilla. Inicie sesi√≥n nuevamente.");
      } else if (status === 404) {
        throw new Error("La plantilla no est√° disponible en este momento.");
      }
    } else if (error.request) {
      throw new Error("Error de conexi√≥n. Verifique su conexi√≥n a internet.");
    }
    
    throw new Error("Error inesperado al descargar la plantilla.");
  }
};

export const categoriasNiveles = async () => {
  try {
    console.log("üì§ Obteniendo todas las categor√≠as");
    const response = await api.get('/categoryLevelUser');
    console.log("‚úÖ Categor√≠as obtenidas:", response.data);
    return response.data;
  } catch (error) {
    console.error("‚ùå Error al obtener categor√≠as:", error);
    throw error;
  }
};

// Verificar competidores existentes
export const verificarCompetidoresExistentes = async (competidores) => {
  try {
    console.log("üì§ Verificando competidores existentes:", competidores);
    const response = await api.post('/inscripcion/grupal/verificar-competidores', {
      competidores
    });
    console.log("‚úÖ Verificaci√≥n completada:", response.data);
    return response;
  } catch (error) {
    console.error("‚ùå Error al verificar competidores:", error);
    throw error;
  }
};

// Registrar competidores sin duplicados
export const registrarCompetidoresSinDuplicados = async (procesoId, competidores, indicesOmitir = []) => {
  try {
    console.log("üì§ Registrando competidores sin duplicados:", { procesoId, competidores, indicesOmitir });
    const response = await api.post(`/inscripcion/grupal/proceso/${procesoId}/competidores-sin-duplicados`, {
      competidores,
      indices_omitir: indicesOmitir
    });
    console.log("‚úÖ Competidores registrados sin duplicados:", response.data);
    return response;
  } catch (error) {
    console.error("‚ùå Error al registrar competidores sin duplicados:", error);
    throw error;
  }
};

// Asociar competidores existentes
export const asociarCompetidoresExistentes = async (procesoId, competidoresIds) => {
  try {
    console.log("üì§ Asociando competidores existentes:", { procesoId, competidoresIds });
    const response = await api.post(`/inscripcion/grupal/proceso/${procesoId}/asociar-competidores`, {
      competidores_ids: competidoresIds
    });
    console.log("‚úÖ Competidores asociados:", response.data);
    return response;
  } catch (error) {
    console.error("‚ùå Error al asociar competidores:", error);
    throw error;
  }
};

// Funciones compartidas que se usan en inscripci√≥n grupal

// Obtener √°reas por olimpiada (reutilizada de inscripcionService)
export const obtenerAreasPorOlimpiada = async (olimpiadaId) => {
  try {
    const response = await api.get(`/user/olimpiadas/${olimpiadaId}/areas`);
    const areasObtenidas = response.data;
    console.log("Areas obtenidas correctamente: ", areasObtenidas);
    return areasObtenidas;
  } catch (error) {
    console.error(
      `Error al obtener las √°reas de la olimpiada ${olimpiadaId}:`,
      error
    );
    throw error;
  }
};

// Obtener categor√≠as por √°rea (reutilizada de inscripcionService)
export const obtenerCategoriasPorArea = async (areaId) => {
  return await api.get(`/user/categoryLevel/area/${areaId}`);
};

// Funci√≥n auxiliar para obtener todas las √°reas
export const obtenerTodasLasAreas = async () => {
  try {
    const response = await api.get("/libre/areas");
    console.log("‚úÖ √Åreas obtenidas:", response.data);
    return response.data;
  } catch (error) {
    console.error("‚ùå Error al obtener √°reas:", error);
    throw error;
  }
};

// Funci√≥n para obtener √°reas de inscripci√≥n
export const inscripcionArea = async () => {
  return await api.get("/inscripcion/area");
};

// Funci√≥n espec√≠fica para obtener √°reas por olimpiada para inscripci√≥n grupal
export const obtenerAreasPorOlimpiadaEspecifica = async (olimpiadaId) => {
  try {
    const response = await api.get(`/user/olimpiadas/${olimpiadaId}/areas`);
    console.log("‚úÖ √Åreas espec√≠ficas obtenidas:", response.data);
    return response.data;
  } catch (error) {
    console.error("‚ùå Error al obtener √°reas espec√≠ficas:", error);
    throw error;
  }
};
